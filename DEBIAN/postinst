#!/bin/bash
set -e
set -x  # Debug: prints commands as they run

# -----------------------------
# Configuration
# -----------------------------
RULES_DIR="/usr/share/X11/xkb/rules"
DOC_DIR="/usr/share/doc/romala-keyboard"
LAYOUT_NAME="romala"

# Paths inside the .deb (relative to the installed package)
SNIPPET_SRC_DIR="/usr/share/doc/romala-keyboard"  # Will copy files here first
SNIPPET_XML="layout_snippet.xml"
SNIPPET_LST="layout_snippet.lst"

# -----------------------------
# Ensure doc folder exists and copy snippet files
# -----------------------------
install -d "$DOC_DIR"
cp -f "./snippets/$SNIPPET_XML" "$DOC_DIR/$SNIPPET_XML"
cp -f "./snippets/$SNIPPET_LST" "$DOC_DIR/$SNIPPET_LST"

echo "ðŸ“„ Copied layout snippets to $DOC_DIR"

# -----------------------------
# Add to .lst files
# -----------------------------
for FILE in base.lst evdev.lst; do
    TARGET_FILE="$RULES_DIR/$FILE"
    if ! grep -q "Romala" "$TARGET_FILE"; then
        sed -i "/! layout/a\  rom             Romala" "$TARGET_FILE"
        echo "â†’ Added $LAYOUT_NAME to $TARGET_FILE"
    else
        echo "â†’ $LAYOUT_NAME already present in $TARGET_FILE"
    fi
done

# -----------------------------
# Add to .xml files
# -----------------------------
for FILE in base.xml evdev.xml; do
    TARGET_FILE="$RULES_DIR/$FILE"
    if ! grep -q "<name>$LAYOUT_NAME</name>" "$TARGET_FILE"; then
        sed -i "/<layoutList>/r $DOC_DIR/$SNIPPET_XML" "$TARGET_FILE"
        echo "â†’ Added $LAYOUT_NAME layout block to $TARGET_FILE"
    else
        echo "â†’ $LAYOUT_NAME already present in $TARGET_FILE"
    fi
done

echo "âœ… Romala keyboard layout installation complete."

